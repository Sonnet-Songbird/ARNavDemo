<!DOCTYPE html>
<html lang="en">
<script src="../aframe/build/aframe-master.min.js"></script>
<script src="../aframe/build/aframe-ar.js"></script>
<head>
    <meta charset="utf-8">
    <title>A-Frame Navigation</title>
    <script>
        function initFromQuerystring() {
            const id = AFRAME.utils.getUrlParameter("posId")
            if (id) {
                getPosById()
            }
        }

        AFRAME.registerComponent('location-marker', {
            init: function () {
                const marker = this.el;
                const markerId = marker.value

                marker.addEventListener('markerFound', function () {
                    if (!scanTimeout) {
                        scanningId = markerId
                        startScan(marker)
                        console.log("markerFound" + markerId)
                    }
                });

                marker.addEventListener('markerLost', function () {
                    if (scanningId === markerId) {
                        clearScan()
                    }
                    console.log("markerLost" + markerId)
                });
            }
        });
        let scanTimeout = null;
        let scanningId = null;

        function startScan(marker) {
            console.log("scan started" + scanningId)
            marker.appendChild(loadingElem);
            return setTimeout(function () {
                doneScan(scanningId);
            }, 4000);
        }

        function clearScan() {
            if (scanTimeout) {
                clearTimeout(scanTimeout);
            }
            scanTimeout = null;
            scanningId = null;
            console.log("scan canceled" + scanningId)
        }

        function doneScan(markerId) {
            getPosById(markerId)
            console.log("scan done" + scanningId)
        }


        function getPosById(posId) {

        }

        const loadingElem = () => {
            const elem = document.createElement("a-torus");
            elem.setAttribute("animation", "property: rotation; to:360 0 0; dur: 5000; easing: linear; loop: true");
            return elem;
        }

    </script>

</head>
<body>
    <!--    <a-scene-->
    <!--            vr-mode-ui="enabled: false"-->
    <!--            cursor='rayOrigin: mouse'-->
    <!--            raycaster='near: 0; far: 50000'-->
    <!--            arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;'-->
    <!--            renderer='antialias: true; alpha: true'>-->


    <!--        <a-marker type='barcode' value='1' smooth="true" location-marker>-->
    <!--        </a-marker>-->

    <!--        <a-marker type='barcode' value='2' smooth="true" location-marker>-->
    <!--        </a-marker>-->

    <!--        <a-marker type='barcode' value='3' smooth="true" location-marker>-->
    <!--        </a-marker>-->
    <!--        <a-entity camera></a-entity>-->
    <a-scene embedded arjs='sourceType: webcam; detectionMode: mono_and_matrix; matrixCodeType: 3x3;'
             vr-mode-ui="enabled: false"
             cursor='rayOrigin: mouse'
             raycaster='near: 0; far: 50000'
             renderer='precision: medium;'>
        <a-marker type='barcode' value='1' smooth="true" location-marker>
            <a-box position='0 0.5 0' material='opacity: 0.5; side: double;color:red;'>
                <a-torus-knot radius='0.26' radius-tubular='0.05'
                              animation="property: rotation; to:360 0 0; dur: 5000; easing: linear; loop: true">
                </a-torus-knot>
            </a-box>
        </a-marker>

        <a-marker type='barcode' value='2' smooth="true" location-marker>
            <a-box position='0 0.5 0' material='opacity: 0.5; side: double;color:pink;'>
                <a-torus-knot radius='0.26' radius-tubular='0.05'
                              animation="property: rotation; to:360 0 0; dur: 5000; easing: linear; loop: true">
                </a-torus-knot>
            </a-box>
        </a-marker>

        <a-marker type='barcode' value='3' smooth="true" location-marker>
            <a-box position='0 0.5 0' material='opacity: 0.5; side: double;color:green;'>
                <a-torus-knot radius='0.26' radius-tubular='0.05'
                              animation="property: rotation; to:360 0 0; dur: 5000; easing: linear; loop: true">
                </a-torus-knot>
            </a-box>
        </a-marker>
        <a-entity camera></a-entity>
    </a-scene>
</body>

</html>
